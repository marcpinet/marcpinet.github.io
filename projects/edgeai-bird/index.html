<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
        EdgeAI Bird
    </title><link href=/favicon.ico rel=icon type=image/png><link href="https://marcpinet.fr/ atom.xml" title="Marc Pinet" rel=alternate type=application/atom+xml><link href=https://marcpinet.fr/main.css media=screen rel=stylesheet><script src=https://marcpinet.fr/elasticlunr.min.js></script><script src=https://marcpinet.fr/search_index.en.js></script><script src=https://marcpinet.fr/search.js></script><meta content="My Personal Website" name=description><meta content="My Personal Website" name=description><meta content="index, follow" name=robots><meta content="Marc Pinet" property=og:title><meta content=website property=og:type><meta content=#fa6b06 name=theme-color><meta content=https://marcpinet.fr/projects/edgeai-bird/ property=og:url><meta content="My Personal Website" property=og:description><meta content="Marc Pinet" property=og:site_name><script type=application/ld+json>
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Marc Pinet",
      "url": "https:&#x2F;&#x2F;marcpinet.fr",
      "image": "https://marcpinet.fr/homepage/me.jpg",
      "description": "My Personal Website",
      "sameAs": [
        
          
        
          
        
          
            "https:&#x2F;&#x2F;scholar.google.com&#x2F;citations?user=NsXT970AAAAJ",
          
        
          
            "https:&#x2F;&#x2F;github.com&#x2F;marcpinet&#x2F;",
          
        
          
            "https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;marc-pinet&#x2F;",
          
        
          
            "https:&#x2F;&#x2F;x.com&#x2F;marcpinet0&#x2F;",
          
        
          
        
      ]
    }
    </script></head><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><header><div class=navbar><button aria-label="Open menu" class=hamburger-button style=background:none><div class=hamburger-icon><span></span><span></span><span></span></div></button><div class=navbar-home-title><a class="nav-links home-title" href=https://marcpinet.fr>Marc Pinet</a></div><div class=navbar-mobile-theme-switcher><label class=theme-switcher for=navbar-mobile-themeswitch><div class=background></div> <input id=navbar-mobile-themeswitch type=checkbox> <div class=switch><img alt="theme switch to dark" class=moon src=/menu_icon/moon.png><img alt="theme switch to light" class=sun src=/menu_icon/sun.png></div></label></div><div class="nav-title nav-navs"><a class="nav-links home-title" href=https://marcpinet.fr>Marc Pinet</a></div><nav class="nav-title nav-navs"><a class=nav-links href=/projects style=display:inline-block;line-height:1.2;vertical-align:middle> <img alt=Projects height=20 src=/menu_icon/projects.png style=vertical-align:middle width=20> Projects</a><a class=nav-links href=/about style=display:inline-block;line-height:1.2;vertical-align:middle> <img alt=About height=20 me src=/menu_icon/about_me.png style=vertical-align:middle width=20> About Me</a></nav><nav class="socials nav-navs"><div class=search-container><input placeholder="üîé Search" id=search type=search><div class=search-results><div class=search-results__items></div></div></div><label class=theme-switcher for=themeswitch><div class=background></div> <input id=themeswitch type=checkbox> <div class=switch><img alt="theme switch to dark" class=moon src=/menu_icon/moon.png><img alt="theme switch to light" class=sun src=/menu_icon/sun.png></div></label></nav></div></header><div class=mobile-menu-overlay></div><div class=mobile-menu><div class=mobile-menu-header><a class=home-title-mobile href=https://marcpinet.fr>Marc Pinet</a><button aria-label="Close menu" class=mobile-menu-close style=background:none>√ó</button></div><div class=mobile-menu-content><div class=mobile-menu-items><a class="mobile-menu-item mobile-home-item" href=https://marcpinet.fr> <img alt=Home src=/menu_icon/home.png> Home </a><a class=mobile-menu-item href=/projects> <img alt=Projects height=20 src=/menu_icon/projects.png width=20> Projects </a><a class=mobile-menu-item href=/about> <img alt=About height=20 me src=/menu_icon/about_me.png width=20> About Me </a></div><div class=mobile-search-container><div class=mobile-search-wrapper><input id=mobile-search placeholder=Search type=search></div><div class=mobile-search-results><div class=mobile-search-results__items></div></div></div><div class=mobile-footer><div class=mobile-footer-socials><a rel="noopener noreferrer" href=mailto:marc.pinet.06@gmail.com target=_blank> <img alt=Email src=/social_icons/email.svg title=Email> </a><a rel="noopener noreferrer" href=https://raw.githubusercontent.com/marcpinet/marcpinet.github.io/cv/cv.pdf target=_blank> <img alt=CV src=/social_icons/cv.svg title=CV> </a><a href="https://scholar.google.com/citations?user=NsXT970AAAAJ" rel="noopener noreferrer" target=_blank> <img alt=Scholar src=/social_icons/scholar.svg title=Scholar> </a><a rel="noopener noreferrer" href=https://github.com/marcpinet/ target=_blank> <img alt=Github src=/social_icons/github.svg title=Github> </a><a rel="noopener noreferrer" href=https://www.linkedin.com/in/marc-pinet/ target=_blank> <img alt=Linkedin src=/social_icons/linkedin.svg title=Linkedin> </a><a rel="noopener noreferrer" href=https://x.com/marcpinet0/ target=_blank> <img alt=X src=/social_icons/x.svg title=X> </a><a rel="noopener noreferrer" href=/atom.xml target=_blank> <img alt=RSS src=/social_icons/rss.svg title=RSS> </a></div></div></div></div><script src=https://marcpinet.fr/mobile-menu.js></script><div class=content><style>h1{font-size:3rem;line-height:1.5}h2{font-size:2.5rem;line-height:1.3}h3{font-size:2rem;line-height:1.3}h4{font-size:1.5rem;line-height:1.3}h5{font-size:1rem;line-height:.5}span.keyword{color:#ff6d00}div.image{text-align:center}.tooltip{position:relative}.tooltip-image{display:none;position:absolute;bottom:100%;left:50%;transform:translateX(-50%);width:200px;background-color:#171717;border:1px solid black}.tooltip:hover .tooltip-image {display:block}h2:before {content:"";display:block;height:1px;background-color:#35393b;margin-top:5vh;margin-bottom:5vh}</style><main><article><div class=title><div class=meta><br></div></div><h2>Table of Contents</h2><ul><li><a href=https://marcpinet.fr/projects/edgeai-bird/#speaking-head-edgeai-bird-species-detection>üó£Ô∏è EdgeAI: Bird Species Detection</a> <ul><li><a href=https://marcpinet.fr/projects/edgeai-bird/#memo-description>üìù Description</a><li><a href=https://marcpinet.fr/projects/edgeai-bird/#arrows-counterclockwise-workflow>üîÑ Workflow</a><li><a href=https://marcpinet.fr/projects/edgeai-bird/#brain-cnn-model>üß† CNN Model</a><li><a href=https://marcpinet.fr/projects/edgeai-bird/#electric-plug-microcontroller-processing-architecture>üîå Microcontroller Processing Architecture</a><li><a href=https://marcpinet.fr/projects/edgeai-bird/#bar-chart-results>üìä Results</a><li><a href=https://marcpinet.fr/projects/edgeai-bird/#dart-conclusion>üéØ Conclusion</a><li><a href=https://marcpinet.fr/projects/edgeai-bird/#crystal-ball-what-would-we-had-done-if-we-had-more-time>üîÆ What would we had done if we had more time?</a><li><a href=https://marcpinet.fr/projects/edgeai-bird/#writing-hand-authors>‚úçÔ∏è Authors</a><li><a href=https://marcpinet.fr/projects/edgeai-bird/#page-with-curl-license>üìÉ License</a></ul></ul><br><hr><br><section class=body><style>.github-alert{border-radius:6px;margin:16px 0;padding:12px 16px;border-left:4px solid}.github-alert-note{background-color:#ddf4ff;border-color:#0969da}.github-alert-tip{background-color:#dcfce7;border-color:#1a7f37}.github-alert-important{background-color:#f3e8ff;border-color:#8250df}.github-alert-warning{background-color:#fff8dc;border-color:#d1242f}.github-alert-caution{background-color:#ffebee;border-color:#d1242f}.table-wrapper{overflow-x:auto;margin:16px 0}.table-wrapper table{width:100%;border-collapse:collapse}.table-wrapper td,.table-wrapper th{border:1px solid #d1d5da;padding:8px 12px;text-align:left}.table-wrapper th{font-weight:600}video{max-width:100%;height:auto;border-radius:6px;margin:16px 0}pre{background-color:#f6f8fa;border-radius:6px;padding:16px;overflow-x:auto;margin:16px 0}code{background-color:#f6f8fa;padding:2px 4px;border-radius:3px;font-family:'SFMono-Regular','Monaco','Inconsolata','Liberation Mono','Consolas',monospace;font-size:85%;color:#24292f}pre code{background-color:transparent;padding:0}@media (prefers-color-scheme: dark){pre{background-color:#161b22;color:#f0f6fc}code{background-color:#21262d;color:#f0f6fc}pre code{background-color:transparent;color:inherit}}</style><h1 id=speaking-head-edgeai-bird-species-detection>üó£Ô∏è EdgeAI: Bird Species Detection</h1><h2 id=memo-description>üìù Description</h2><p>The goal of this project is to perform classification of audio samples collected from the microphone on the RFThings-AI Dev Kit board, which is equipped with an STM32L476RGT6 Microcontroller. The target application is bird species detection from songs for the following 3 species: Emberiza cirlus, Muscicapa striata, and Alauda arvensis.<h2 id=arrows-counterclockwise-workflow>üîÑ Workflow</h2><p>The overall workflow to solve the bird species detection problem consists of the following steps:<ol><li><p>Train a Convolutional Neural Network (CNN) model on a custom dataset, which contains audio samples of the songs of the 3 bird species. The model is trained in Python using Keras/TensorFlow.</p><li><p>Convert the trained Keras model to optimized C code that can run on the microcontroller, using the qualia_codegen_core library. Quantize the model weights and activations to 16-bit fixed-point to reduce memory footprint.</p><li><p>Implement data acquisition on the microcontroller by reading audio samples from the on-board I2S microphone into a buffer using DMA.</p><li><p>When the audio input buffer is full (1 second of audio data), perform preprocessing (DC offset removal and amplification) and then run inference using the quantized CNN model to detect the bird species.</p><li><p>If a bird species is detected with high confidence, send the prediction result over LoRaWAN to a server (The Things Network).</p></ol><p>The overall data flow is illustrated in this diagram:<p>üéôÔ∏è Microphone -> üîÑ I2S (DMA) -> üóÉÔ∏è Audio Buffer -> ‚öôÔ∏è Preprocessing -> üß† CNN Model -> üì° LoRaWAN -> ‚òÅÔ∏è Server<h2 id=brain-cnn-model>üß† CNN Model</h2><p>The CNN model used is based on the M5 architecture from <a href=https://arxiv.org/pdf/1610.00087.pdf>this paper</a>. It consists of several 1D convolution and pooling layers:<pre class=z-code><code><span class="z-text z-plain">Input(16000 x 1) 
</span><span class="z-text z-plain">-> MaxPool1D(pool_size=2, strides=2)
</span><span class="z-text z-plain">-> Conv1D(8 filters, kernel_size=40, strides=4, ReLU) 
</span><span class="z-text z-plain">-> MaxPool1D(pool_size=4, strides=4)  
</span><span class="z-text z-plain">-> Conv1D(16 filters, kernel_size=2, ReLU)
</span><span class="z-text z-plain">-> MaxPool1D(pool_size=4, strides=4)
</span><span class="z-text z-plain">-> Conv1D(32 filters, kernel_size=2, ReLU)  
</span><span class="z-text z-plain">-> MaxPool1D(pool_size=4, strides=4)
</span><span class="z-text z-plain">-> Conv1D(32 filters, kernel_size=2, ReLU)
</span><span class="z-text z-plain">-> MaxPool1D(pool_size=4, strides=4)  
</span><span class="z-text z-plain">-> AvgPool1D()
</span><span class="z-text z-plain">-> Flatten()
</span><span class="z-text z-plain">-> Dense(3)
</span><span class="z-text z-plain">-> Softmax
</span></code></pre><p>The model was trained for 34 epochs using the Adam optimizer, reaching over 80% accuracy on the test set. The trained model was then converted to int16 Q9.7 fixed-point using the qualia_codegen_core library and compiled to C code.<h2 id=electric-plug-microcontroller-processing-architecture>üîå Microcontroller Processing Architecture</h2><p>On the microcontroller, audio data is captured from the I2S microphone, which includes an analog-to-digital converter (ADC). The ADC converts the analog audio signal to digital samples.<p>The I2S interface consists of at least 3 signals:<ul><li>Bit clock (BCK) - continuous clock signal that determines speed of data transfer<li>Word select (WS) - indicates which channel (left or right) the data is for<li>Data (SD) - serial data signal</ul><p>The I2S data is automatically moved into a buffer in memory using Direct Memory Access (DMA). DMA allows data transfer between peripherals and memory without involving the CPU, enabling the microphone samples to be collected in the background while the CPU performs other tasks.<p>When the DMA input buffer contains 1 second worth of audio samples (16000 samples at 16kHz), a flag is set to trigger the preprocessing and inference pipeline. The audio data is first processed to remove DC offset and amplify the signal. The processed data is then passed into the quantized CNN model to detect the bird species.<h2 id=bar-chart-results>üìä Results</h2><p>The CNN model was first evaluated on the full test set, achieving an accuracy of 80%. It was then evaluated on a subset of 250 samples, reaching an accuracy of 78%.<p>To validate real-world performance, the model was tested on the microcontroller by playing recordings of the songs of the 3 bird species through a speaker placed near the board's microphone. The model was able to reliably detect the bird species in 70% of cases. Some misclassifications occurred for similar sounding songs.<p>Performance metrics:<ul><li>Accuracy on full test set: 86%<li>Accuracy on 250 sample test subset: 84%<li>Accuracy on real bird song recordings: ~75%<li>Model memory footprint: 83 KB flash, 20 KB SRAM<li>Inference latency: 123 ms<li>Estimated power consumption: ~45 mW<li>Estimated battery life: 51 hours (assuming 700 mAh battery)</ul><h2 id=dart-conclusion>üéØ Conclusion</h2><p>This project demonstrates an end-to-end pipeline for deploying a neural network for bird species detection from songs on a resource-constrained microcontroller. The CNN model is able to achieve good accuracy on the bird species detection task. Quantization to 16-bit fixed-point allows it to fit within the memory limits of the STM32 MCU.<p>Key techniques used include DMA for efficient audio sampling, fixed-point quantization for model compression, and LoRaWAN for low-power wireless connectivity to a server.<p>Some areas for future enhancement:<ul><li>Expand the species vocabulary beyond the current 3<li>Further optimize the CNN architecture to reduce memory footprint and latency<li>Explore duty cycling and other techniques to reduce power consumption<li>Add a voice activity detector to only run inference when a song is detected</ul><p>In summary, this project provides a template for deploying always-on audio classifiers on embedded devices for tasks like bird song detection, opening up many possibilities for audio event detection on the edge.<h2 id=crystal-ball-what-would-we-had-done-if-we-had-more-time>üîÆ What would we had done if we had more time?</h2><ul><li>Fix the confidence value which is too high sometimes<li>Implement a circular buffer inside the microphone arduino handler to avoid cuts in the audio stream<li>Maximizing the model accuracy while lowering its size</ul><h2 id=writing-hand-authors>‚úçÔ∏è Authors</h2><p>Marc Pinet - <a href=https://github.com/marcpinet/>marcpinet</a><br><h2 id=page-with-curl-license>üìÉ License</h2><p>This project is licensed under the MIT License - see the <a href=https://github.com/marcpinet/edgeai-bird/tree/main/LICENSE>LICENSE</a> file for details</p><br><hr><br></section></article></main><noscript>Please enable JavaScript for accessing the comments</noscript><script>(function(){const a=localStorage.getItem('theme');const b=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;const c=a?a==='dark':b;const d=c?'dark_dimmed':'light';const e=document.createElement('script');e.src='https://giscus.app/client.js';e.setAttribute('data-repo','marcpinet/marcpinet.github.io');e.setAttribute('data-repo-id','R_kgDOJDP6MA');e.setAttribute('data-category','Q&A');e.setAttribute('data-category-id','DIC_kwDOJDP6MM4CUiRW');e.setAttribute('data-mapping','title');e.setAttribute('data-strict','0');e.setAttribute('data-reactions-enabled','1');e.setAttribute('data-emit-metadata','0');e.setAttribute('data-input-position','bottom');e.setAttribute('data-theme',d);e.setAttribute('data-lang','en');e.setAttribute('data-loading','lazy');e.setAttribute('crossorigin','anonymous');e.async=true;document.currentScript.parentNode.insertBefore(e,document.currentScript.nextSibling)})();function updateGiscusTheme(){const a=localStorage.getItem('theme');const b=a==='light';const c=b?'light':'dark_dimmed';const d={setConfig:{theme:c}};const e=document.querySelector('.giscus-frame');if(e){e.contentWindow.postMessage({giscus:d},'https://giscus.app')}}window.addEventListener('load',function(){const a=document.querySelectorAll('.theme-switcher input');a.forEach(b=>{b.addEventListener('change',()=>setTimeout(updateGiscusTheme,100))})})</script></div><footer><section><nav><a class="nav-links social" rel="noopener noreferrer" href=mailto:marc.pinet.06@gmail.com target=_blank> <img alt=Email src=/social_icons/email.svg title=Email> </a><a class="nav-links social" rel="noopener noreferrer" href=https://raw.githubusercontent.com/marcpinet/marcpinet.github.io/cv/cv.pdf target=_blank> <img alt=CV src=/social_icons/cv.svg title=CV> </a><a class="nav-links social" href="https://scholar.google.com/citations?user=NsXT970AAAAJ" rel="noopener noreferrer" target=_blank> <img alt=Scholar src=/social_icons/scholar.svg title=Scholar> </a><a class="nav-links social" rel="noopener noreferrer" href=https://github.com/marcpinet/ target=_blank> <img alt=Github src=/social_icons/github.svg title=Github> </a><a class="nav-links social" rel="noopener noreferrer" href=https://www.linkedin.com/in/marc-pinet/ target=_blank> <img alt=Linkedin src=/social_icons/linkedin.svg title=Linkedin> </a><a class="nav-links social" rel="noopener noreferrer" href=https://x.com/marcpinet0/ target=_blank> <img alt=X src=/social_icons/x.svg title=X> </a><a class="nav-links social" rel="noopener noreferrer" href=/atom.xml target=_blank> <img alt=RSS src=/social_icons/rss.svg title=RSS> </a></nav><nav><span classname=desktop-only>Made by <a rel="noopener noreferrer" href=https://www.linkedin.com/in/marc-pinet/ target=_blank>Marc Pinet</a> and powered by <a rel="noopener noreferrer" href=https://getzola.org/ target=_blank>Zola</a></span></nav></section><script src=https://marcpinet.fr/js/main.js></script></footer><script src=https://marcpinet.fr/elasticlunr.min.js></script><script src=https://marcpinet.fr/search.js></script><script src=https://marcpinet.fr/js/fields-toggle.js></script><script src=https://marcpinet.fr/js/enhanced-ui.js></script><script src=https://marcpinet.fr/js/matrix-mode.js></script>